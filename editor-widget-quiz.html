<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>自我測驗編輯</title>

		<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
		<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
		<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>

		<!-- 自己的 -->
		<script type="text/javascript">
			var Editor = new Object();
			Editor.widgetId = 6;

			$(document).ready(function() {
				//alert('test');

				if (getValue('ID'))
					Editor.widgetId = getValue('ID');
				//alert('ID=' + Editor.widgetId);
				
				//載入題組
				var link = "widgets/" + Editor.widgetId + ".wdgt/index.html";
				$('#contentL').load(link, function() {
					//alert('laod');
					$(this).find('#widget_id').text(Editor.widgetId).hide();
					$('#quiz_result').hide();
					$('#contentL button').hide();
					//$(this).find('#widget_id').hide();

					// 內容排序
					$(this).find('ol').sortable({
						revert : true
						// 移動動畫
					});

					// 外觀設定
					setLook();
					// 刪除設定
					setRemove();
					// 物件不能選擇
					$("ul, li, h3").disableSelection();

					// 加入元件
					$('.quiz_sample li, .quiz_sample h3').draggable({
						connectToSortable : "#quiz_content ol",
						helper : "clone",
						revert : "invalid",
						stop : function() {
							setLook();
							setRemove();
						}
					});
				});

				$('#tabs').tabs();
				$('#saveHtml').click(function() {
					saveDocument(Editor.widgetId);
				});

				/*
				* 範本內容變更
				*/
				//標題
				$('#title_string').change(function() {
					$('#tabs-4 h3').html($(this).val());
				});

				//填空
				$('#blank_string').change(function() {
					$('#tabs-3 .quiz_string').html($(this).val());
				});
				$('#blank_answer').change(function() {
					var str = $('#blank_edit form').serialize();
					//alert(str);
					str = decodeURIComponent(str, true);
					$('#tabs-3 .quiz_ans').html(str);
				});
				$('#blank_comment').change(function() {
					$('#tabs-3 .quiz_comment').html($(this).val());
				});

				//單選
				$('#single_string').change(function() {
					$('#tabs-2 .quiz_string').html($(this).val());
				});
				$('#single_choice').change(function() {
					var str = $(this).val().split(',');
					var option = "";
					var option2 = "";
					//產生選擇器
					//$('#multi_edit').append("<form>答案 "+str[1]+"</form>"+str.length);
					for (var i = 0; i < str.length; ++i) {
						if (str[i] != "") {
							option += '<input type="radio" name="answer" value="' + str[i] + '">' + str[i];
							option2 += '<option>' + str[i];
						}
					}
					//alert(option);
					$('#tabs-2 .choice').html(option);
					$('#quiz_single2 .answer').html(option2);

					$('#single_edit form input').change(function() {
						var str = $('#single_edit form').serialize();
						str = decodeURIComponent(str, true);
						$('#tabs-2 .quiz_ans').html(str);
					});
				});
				$('#single_comment').change(function() {
					$('#tabs-2 .quiz_comment').html($(this).val());
				});

				//多選
				$('#multi_string').change(function() {
					$('#tabs-1 .quiz_string').html($(this).val());
				});
				$('#multi_answer').change(function() {
					var str = $(this).val().split(',');
					var option = "";
					//產生選擇器
					//$('#multi_edit').append("<form>答案 "+str[1]+"</form>"+str.length);
					for (var i = 0; i < str.length; ++i) {
						if (str[i] != "") {
							option += '<input type="checkbox" name="answer" value="' + str[i] + '">' + str[i];
						}
					}

					$('#tabs-1 .choice').html(option);

					$('#multi_edit form input').change(function() {
						var str = $('#multi_edit form').serialize();
						str = decodeURIComponent(str, true);
						$('#tabs-1 .quiz_ans').html(str);
					});
				});
				$('#multi_comment').change(function() {
					$('#tabs-1 .quiz_comment').text($(this).val());
				});
			})
			function saveDocument(id) {
				//$('#contentSave').text($('#contentL').html());

				var data_send = new Object();
				data_send.wdid = id;
				data_send.mode = 'save_html'; 
				data_send.data = $('#contentL').html();
				myGet(data_send, function (data){
					alert("回傳資料："+ data.json);
					//alert("data:"+data[0].data);
					//$('body').append(JSON.stringify(data));
					//loadTable(iWidgetId);
					//alert("回傳資料："+getValue('id'));

					//loadTable(getValue('id'));

					//showTable(data);
				});
			}

			var setLook = function() {
				// 外觀設置
				$('#quiz_content li, #quiz_content h3').css('border', '1px gray dashed');
				$("ul, li, h3").disableSelection();
			};

			var setRemove = function() {
				// 雙擊刪除
				$('#quiz_content li, #quiz_content h3').dblclick(function() {
					$(this).remove();
				});
			};

			function getValue(varname) {
				var url = window.location.href;
				var qparts = url.split("?");
				if (qparts.length == 0) {
					return "";
				}
				var query = qparts[1];
				var vars = query.split("&amp;");
				var value = "";
				for ( i = 0; i < vars.length; i++) {
					var parts = vars[i].split("=");
					if (parts[0] == varname) {
						value = parts[1];
						break;
					}
				}
				value = unescape(value);
				value.replace(/\+/g, " ");
				return value;
			}
			function myGet(mjson, mfunction) {
				$.getJSON('editor/handle-gets.php', mjson, function(data) {
					mfunction(data);
				});
			}
		</script>

		<style type="text/css">
			body {
				width: 800px;
				margin: 0 auto;
				font-size: 1em;
			}

			#contentL, #contentR {
				width: 49%;
				float: left;
				padding: 0 2px;
			}
		</style>
	</head>
	<body>

		<header>
			<h1>自我測驗編輯</h1>
		</header>

		<div id="content" style="float: left">

			<div id="contentL">

			</div>
			<div id="contentR">

				<div id="tabs">
					<ul>
						<li>
							<a href="#tabs-1">多選</a>
						</li>
						<li>
							<a href="#tabs-2">單選</a>
						</li>
						<li>
							<a href="#tabs-3">填空</a>
						</li>
						<li>
							<a href="#tabs-4">標題</a>
						</li>
					</ul>
					<div id="tabs-1">
						<div id="quiz_multi" class="quiz_sample">
							<!--多選題-->
							<li>
								<div class="quiz_string">
									你要問的問題?
								</div>
								<form id="check">
									<div class="choice">
										<input type="checkbox" value="choice1" name="answer">
										選項1
										<input type="checkbox" value="choice2" name="answer">
										選項2
										<input type="checkbox" value="choice3" name="answer">
										選項3
										<input type="checkbox" value="choice4" name="answer">
										選項4
									</div>
									<div class="quiz_ans">
										answer=選項2&answer=選項3
									</div>
								</form>
								<div class="quiz_comment">
									問題相關註解
								</div>
							</li>
						</div>
						<div id="multi_edit">
							<h3>設定題組內容</h3>
							問題
							<input type="text" id="multi_string" />
							<br />
							選項
							<input type="text" id="multi_answer" />
							<br />
							註解
							<input type="text" id="multi_comment" />
							<br />
							<form>
								答案 <span class="choice"></span>
							</form>
						</div>
					</div>
					<div id="tabs-2">
						<div id="quiz_single1" class="quiz_sample">
							<!--單選題-->
							<li>
								<div class="quiz_string">
									你要問的問題?
								</div>
								<form>
									<div class="choice">
										<input type="radio" value="你說呢" name="answer">
										你說呢
										<input type="radio" value="你說呢" name="answer">
										當然囉
										<input type="radio" value="你說呢" name="answer">
										討厭!!
										<input type="radio" value="你說呢" name="answer">
										choose6
									</div>
									<div class="quiz_ans">
										choose1
									</div>
								</form>
								<div class="quiz_comment">
									問題相關註解
								</div>
							</li>
						</div>
						<div id="quiz_single2" class="quiz_sample">
							<!--下拉單選題-->
							<li>
								<div class="quiz_string">
									你要問的問題?
								</div>
								<form>
									<select class="answer">
										<option>初中 <option>choose1<option>高職 <option>專科
									</select>
									<div class="quiz_ans">
										answer=初中
									</div>
								</form>
								<div class="quiz_comment">
									問題相關註解
								</div>

							</li>
						</div>
						<div id="single_edit">
							<h3>設定題組內容</h3>
							問題
							<input type="text" id="single_string" />
							<br />
							選項
							<input type="text" id="single_choice" />
							<br />
							註解
							<input type="text" id="single_comment" />
							<br />
							<form>
								答案 <span class="choice"></span>
							</form>
						</div>
					</div>

					<div id="tabs-3">
						<div id="quiz_blank" class="quiz_sample">
							<!--填空-->
							<li>
								<div class="quiz_string">
									你要問的問題?
								</div>
								<form>
									<input name="answer" type="text">
									<div class="quiz_ans">
										answer=高中
									</div>
								</form>
								<div class="quiz_comment">
									問題相關註解
								</div>

							</li>
						</div>
						<div id="blank_edit">
							<h3>設定題組內容</h3>
							問題
							<input type="text" id="blank_string" />
							<br />

							<form>
								<span>答案 </span>
								<input type="text" name="answer" id="blank_answer" />
							</form>
							<br />
							註解
							<input type="text" id="blank_comment" />
							<br />
						</div>
					</div>
					<div id="tabs-4">
						<div class="quiz_sample">
							<h3>標題</h3>
						</div>
						<p>
							設定標題文字
							<input type="text" id="title_string" />
						</p>
					</div>
				</div>
				<button id="saveHtml">
					存檔
				</button>
			</div>
			<div style="clear:both">
				<!--<h2>準備存的文件檔</h2>-->
				<div id="contentSave"></div>
			</div>
		</div>

	</body>
</html>